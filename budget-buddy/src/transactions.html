<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>BudgetBuddy</title>
    <script>
        window.currentPage = 'transactions';
    </script>
  </head>
  <body
    data-page="transactions"
    x-data="{
          page: 'transactions',loaded: true, darkMode: false, stickyMenu: false, sidebarToggle: false, scrollTop: false, 
          isTransactionModal: false, isCategoryModal: false, isEditMode: false, editingTransactionId: null,
          newTransaction: { description: '', categoryId: '', date: '', type: 'EXPENSE', isPublic: false, amount: null }, 
          newCategory: { name: '' },
          transactions: [], categories: [],
          filters: { category: '', date: '', type: '' }, showFilters: false, filteredTransactions: [],
          loading: false,
          
          async init() {
            try {
              await this.loadCategories();
              await this.fetchTransactions();
              
              setTimeout(() => {
                this.updateTransactionTable();
              }, 100);
            } catch (error) {
              console.error('Error en la inicialización:', error);
              this.showNotification('Error loading initial data', 'error');
            }
          },
          
          async loadCategories() {
            try {
              const response = await fetch('https://pnc-proyecto-final-grupo-02-s01-aqoh.onrender.com/categories', {
                headers: {
                  'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`
                }
              });
              if (response.ok) {
                this.categories = await response.json();
              }
            } catch (error) {
              console.error('Error cargando categorías:', error);
            }
          },
          
          async fetchTransactions() {
            this.loading = true;
            try {
              const response = await fetch('https://pnc-proyecto-final-grupo-02-s01-aqoh.onrender.com/transactions', {
                headers: {
                  'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`
                }
              });
              
              if (response.ok) {
                const serverData = await response.json();
                this.transactions = serverData || [];
                this.updateTransactionTable();
              } else {
                console.error('Error en la respuesta del servidor:', response.status);
                this.transactions = [];
                this.updateTransactionTable();
                this.showNotification('Error cargando transacciones', 'error');
              }
            } catch (err) {
              console.error('Error cargando transacciones:', err);
              this.transactions = [];
              this.updateTransactionTable();
              this.showNotification('Error cargando transacciones', 'error');
            } finally {
              this.loading = false;
            }
          },
          
          async createTransaction() {
            if (!this.validateTransaction()) return;
            
            try {
              const response = await fetch('https://pnc-proyecto-final-grupo-02-s01-aqoh.onrender.com/transactions', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`
                },
                body: JSON.stringify(this.newTransaction)
              });
              
              if (response.ok) {
                this.showNotification('Transacción creada exitosamente', 'success');
                this.resetForm();
                this.isTransactionModal = false;
                await this.fetchTransactions();
                this.updateTransactionTable();
              } else {
                this.showNotification('Error creando transacción', 'error');
              }
            } catch (err) {
              console.error('Error creando transacción:', err);
              this.showNotification('Error creando transacción', 'error');
            }
          },
          
          async updateTransaction() {
            if (!this.validateTransaction()) return;
            
            try {
              const response = await fetch(`https://pnc-proyecto-final-grupo-02-s01-aqoh.onrender.com/transactions/${this.editingTransactionId}`, {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`
                },
                body: JSON.stringify(this.newTransaction)
              });
              
              if (response.ok) {
                this.showNotification('Transaction updated successfully', 'success');
                this.resetForm();
                this.isTransactionModal = false;
                this.isEditMode = false;
                this.editingTransactionId = null;
                await this.fetchTransactions();
                this.updateTransactionTable();
              } else {
                this.showNotification('Error updating transaction', 'error');
              }
            } catch (err) {
              console.error('Error updating transaction:', err);
              this.showNotification('Error updating transaction', 'error');
            }
          },
          
          async deleteTransaction(id) {
            if (!confirm('Are you sure you want to delete this transaction?')) return;
            
            try {
              const response = await fetch(`https://pnc-proyecto-final-grupo-02-s01-aqoh.onrender.com/transactions/${id}`, {
                method: 'DELETE',
                headers: {
                  'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`
                }
              });
              
              if (response.ok) {
                this.showNotification('Transaction successfully deleted', 'success');
                await this.fetchTransactions();
                this.updateTransactionTable();
              } else {
                this.showNotification('Error deleting transaction', 'error');
              }
            } catch (err) {
              console.error('Error deleting transaction:', err);
              this.showNotification('Error deleting transaction', 'error');
            }
          },
          
          validateTransaction() {
            if (!this.newTransaction.description.trim()) {
              this.showNotification('Description is required', 'error');
              return false;
            }
            if (!this.newTransaction.categoryId) {
              this.showNotification('Category is required', 'error');
              return false;
            }
            if (!this.newTransaction.date) {
              this.showNotification('Date is required', 'error');
              return false;
            }
            if (!this.newTransaction.amount || this.newTransaction.amount <= 0) {
              this.showNotification('The amount must be greater than 0', 'error');
              return false;
            }
            return true;
          },
          
          resetForm() {
            this.newTransaction = {
              description: '',
              categoryId: '',
              date: '',
              type: 'EXPENSE',
              isPublic: false,
              amount: null,
            };
          },
          
          openNewTransactionModal() {
            this.isEditMode = false;
            this.editingTransactionId = null;
            this.resetForm();
            this.isTransactionModal = true;
          },
          
          closeModal() {
            this.isTransactionModal = false;
            this.isEditMode = false;
            this.editingTransactionId = null;
            this.resetForm();
          },
          
          addTransaction() {
            this.transactions.push({ ...this.newTransaction });
            this.newTransaction = { description: '', categoryId: '', date: '', type: 'EXPENSE', isPublic: false, amount: null };
            this.isTransactionModal = false;
          },
          
          applyFilters() {
            // see if theres transactions
            if (!this.transactions || !Array.isArray(this.transactions)) {
              console.error('There are no transactions available to filter.');
              this.showNotification('No transactions available', 'error');
              return;
            }
            
            this.filteredTransactions = this.transactions.filter(tx => {
              // backend
              const categoryName = tx.categoryName || '';
              
              return (this.filters.category === '' || categoryName.toLowerCase().includes(this.filters.category.toLowerCase())) &&
                     (this.filters.date === '' || tx.date === this.filters.date) &&
                     (this.filters.type === '' || tx.type === this.filters.type);
            });
            
            // updating after filtering
            if (window.renderTransactionTable) {
              const formattedTransactions = this.filteredTransactions.map(tx => {
                // category name comes from backend
                const categoryName = tx.categoryName || 'No category';
                
                return {
                  id: tx.id,
                  description: tx.description,
                  category: categoryName,
                  categoryId: tx.categoryId,
                  type: tx.type,
                  date: tx.date,
                  visibility: tx.isPublic ? 'Public' : 'Private',
                  amount: `$${tx.amount.toFixed(2)}`,
                  rawAmount: tx.amount,
                  isPublic: tx.isPublic
                };
              });
              window.renderTransactionTable(
                formattedTransactions, 1, 5,
                (transaction) => {
                  // Función de edición
                  this.isEditMode = true;
                  this.editingTransactionId = transaction.id;
                  this.newTransaction = {
                    description: transaction.description,
                    categoryId: transaction.categoryId,
                    date: transaction.date,
                    type: transaction.type,
                    isPublic: transaction.isPublic,
                    amount: transaction.rawAmount,
                  };
                  this.isTransactionModal = true;
                },
                (transaction) => {
                  // Función de eliminación
                  this.deleteTransaction(transaction.id);
                }
              );
            }
            
            this.showFilters = false;
          },
          
          clearFilters() {
            this.filters = { category: '', date: '', type: '' };
            this.filteredTransactions = [];
            this.fetchTransactions();
          },
          
          openCategoryModal() {
            this.isCategoryModal = true;
            this.newCategory = { name: '' };
          },
          
          closeCategoryModal() {
            this.isCategoryModal = false;
            this.newCategory = { name: '' };
          },
          
          async createCategory() {
            if (!this.newCategory.name.trim()) {
              this.showNotification('Please enter the category name', 'error');
              return;
            }
            
            try {
              const response = await fetch('https://pnc-proyecto-final-grupo-02-s01-aqoh.onrender.com/categories', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`
                },
                body: JSON.stringify(this.newCategory)
              });
              
              if (response.ok) {
                const newCategory = await response.json();
                this.categories.push(newCategory);
                this.closeCategoryModal();
                this.showNotification('Categoría creada exitosamente', 'success');
                await this.loadCategories();
                
                setTimeout(() => {
                  window.location.reload();
                }, 500);
              } else {
                this.showNotification('Error creando la categoría', 'error');
              }
            } catch (error) {
              console.error('Error:', error);
              this.showNotification('Error creando la categoría', 'error');
            }
          },
          
          showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
              type === 'success' ? 'bg-green-500 text-white' :
              type === 'error' ? 'bg-red-500 text-white' :
              'bg-blue-500 text-white'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
              notification.remove();
            }, 3000);
          },
          
          updateTransactionTable() {
            if (window.renderTransactionTable && this.transactions && this.transactions.length > 0) {
              const formattedTransactions = this.transactions.map(tx => {
                
                const categoryName = tx.categoryName || 'No category';
                
                return {
                  id: tx.id,
                  description: tx.description,
                  category: categoryName,
                  categoryId: tx.categoryId,
                  type: tx.type,
                  date: tx.date,
                  visibility: tx.isPublic ? 'Public' : 'Private',
                  amount: `$${tx.amount.toFixed(2)}`,
                  rawAmount: tx.amount,
                  isPublic: tx.isPublic
                };
              });
              window.renderTransactionTable(
                formattedTransactions, 1, 5,
                (transaction) => {
                 
                  this.isEditMode = true;
                  this.editingTransactionId = transaction.id;
                  this.newTransaction = {
                    description: transaction.description,
                    categoryId: transaction.categoryId,
                    date: transaction.date,
                    type: transaction.type,
                    isPublic: transaction.isPublic,
                    amount: transaction.rawAmount,
                  };
                  this.isTransactionModal = true;
                },
                (transaction) => {
                  
                  this.deleteTransaction(transaction.id);
                }
              );
            } else if (window.renderTransactionTable) {
              
              window.renderTransactionTable([], 1, 5, 
                (transaction) => {
                  
                  this.isEditMode = true;
                  this.editingTransactionId = transaction.id;
                  this.newTransaction = {
                    description: transaction.description,
                    categoryId: transaction.categoryId,
                    date: transaction.date,
                    type: transaction.type,
                    isPublic: transaction.isPublic,
                    amount: transaction.rawAmount,
                  };
                  this.isTransactionModal = true;
                },
                (transaction) => {
                  
                  this.deleteTransaction(transaction.id);
                }
              );
            }
          },
          
          handleSubmit() {
            if (this.isEditMode) {
              this.updateTransaction();
            } else {
              this.createTransaction();
            }
          }
      }"
    x-init="
      darkMode = JSON.parse(localStorage.getItem('darkMode'));
      $watch('darkMode', value => localStorage.setItem('darkMode', JSON.stringify(value)));
      init();
      "
    :class="{'dark bg-gray-900': darkMode === true}"
  >
    <!-- ===== Preloader Start ===== -->
    <include src="./partials/preloader.html"></include>
    <!-- ===== Preloader End ===== -->

    <!-- ===== Page Wrapper Start ===== -->
    <div class="flex h-screen overflow-hidden">
      <!-- ===== Sidebar Start ===== -->
      <include src="./partials/sidebar.html"></include>
      <!-- ===== Sidebar End ===== -->

      <!-- ===== Content Area Start ===== -->
      <div class="relative flex flex-col flex-1 overflow-x-hidden">
        <!-- Small Device Overlay Start -->
        <include src="./partials/overlay.html" />
        <!-- Small Device Overlay End -->

        <!-- ===== Header Start ===== -->
        <include src="./partials/header.html" />
        <!-- ===== Header End ===== -->

        <!-- ===== Main Content Start ===== -->
        <main>
          <!-- Tittle -->
          <div class="p-4 md:ml-[15px] mt-4">
            <div class="mb-1">
              <h2 class="text-2xl font-semibold text-gray-800 dark:text-white mb-4">Transactions</h2>
              <span class="text-lg font-normal text-gray-500 dark:text-gray-400">
                Do you want to see your recent financial movements and activities? Find them here
              </span>
            </div>
            
            <!-- category button -->
            <div class="mt-4 flex gap-2">
              <button
                @click="openNewTransactionModal()"
                class="inline-flex items-center px-4 py-2 bg-brand-500 hover:bg-brand-600 text-white font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-brand-500 focus:ring-offset-2 dark:bg-brand-500 dark:hover:bg-brand-600""
              >
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                New transaction
              </button>
              <button
                @click="openCategoryModal()"
                class="inline-flex items-center px-4 py-2 bg-brand-500 hover:bg-brand-600 text-white font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-brand-500 focus:ring-offset-2 dark:bg-brand-500 dark:hover:bg-brand-600""
              >
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                New category
              </button>
            </div>
          </div>

          <!-- table container  -->
          <div class="p-2 mx-auto max-w-7xl">
            <div class="col-span-12 xl:col-span-7">
              <!-- ====== Table One Start ====== -->
              <include src="./partials/table/table-01.html" />
              <!-- ====== Table One End ====== -->
            </div>
          </div>
        </main>
        <!-- ===== Main Content End ===== -->
      </div>
      <!-- ===== Content Area End ===== -->
    </div>
    <!-- ===== Page Wrapper End ===== -->

    <!-- Modal para crear/editar transacción -->
    <include src="./partials/transaction-modal/new-transaction-modal.html" />
    
    <!-- Modal para crear nueva categoría -->
    <include src="./partials/transaction-modal/new-category-modal.html" />
  </body>
</html>
