<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Profile | BudgetBuddy</title>
    <script>
      window.currentPage = 'profile';
      const LOCAL_API = 'http://localhost:8081';
    </script>
  </head>
  <body
    data-page="profile"
    x-data="profilePage()"
    x-init="init()"
    :class="{'dark bg-gray-900': darkMode === true}"
  >
    <!-- ===== Preloader Start ===== -->
    <include src="./partials/preloader.html"></include>
    <!-- ===== Preloader End ===== -->

    <!-- ===== Page Wrapper Start ===== -->
    <div class="flex h-screen overflow-hidden">
      <!-- ===== Sidebar Start ===== -->
      <include src="./partials/sidebar.html"></include>
      <!-- ===== Sidebar End ===== -->

      <!-- ===== Content Area Start ===== -->
      <div class="relative flex flex-col flex-1 overflow-x-hidden overflow-y-auto">
        <!-- Small Device Overlay Start -->
        <include src="./partials/overlay.html" />
        <!-- Small Device Overlay End -->

        <!-- ===== Header Start ===== -->
        <include src="./partials/header.html" />
        <!-- ===== Header End ===== -->

        <!-- ===== Main Content Start ===== -->
        <main>
          <div class="p-4 mx-auto max-w-(--breakpoint-2xl) md:p-6">
            <!-- Breadcrumb Start -->
            <div x-data="{ pageName: `Profile`}">
              <include src="./partials/breadcrumb.html" />
            </div>
            <!-- Breadcrumb End -->

            <div
              class="rounded-2xl border border-gray-200 bg-white p-5 dark:border-gray-800 dark:bg-white/[0.03] lg:p-6"
            >
              <h3
                class="mb-5 text-lg font-semibold text-gray-800 dark:text-white/90 lg:mb-7"
              >
                Profile
              </h3>

              <!-- ===== RESUMEN DE PERFIL (NOMBRE / ROL / EMAIL) ===== -->
              <div
                class="p-5 mb-6 border border-gray-200 rounded-2xl dark:border-gray-800 lg:p-6"
              >
                <div
                  class="flex flex-col gap-5 xl:flex-row xl:items-center xl:justify-between"
                >
                  <div class="flex flex-col items-center w-full gap-4 xl:flex-row">
                    <div class="order-3 xl:order-2">
                      <!-- Nombre completo -->
                      <h4
                        class="mb-2 text-lg font-semibold text-center text-gray-800 dark:text-white/90 xl:text-left"
                        x-text="(firstName + ' ' + lastName).trim() || 'Usuario BudgetBuddy'"
                      ></h4>

                      <div
                        class="flex flex-col items-center gap-1 text-center xl:flex-row xl:gap-3 xl:text-left"
                      >
                        <!-- Rol (badge) -->
                        <span
                          class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold
                            bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300"
                          x-text="getRoleLabel()"
                        ></span>

                        <div
                          class="hidden h-3.5 w-px bg-gray-300 dark:bg-gray-700 xl:block"
                        ></div>

                        <!-- Email -->
                        <p
                          class="text-sm text-gray-500 dark:text-gray-400 break-all"
                          x-text="email || 'sin correo'"
                        ></p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ===== INFORMACIÓN PERSONAL (NOMBRE / CORREO / ROL / BIO) ===== -->
              <div
                class="p-5 mb-0 border border-gray-200 rounded-2xl dark:border-gray-800 lg:p-6"
              >
                <div
                  class="flex flex-col gap-6 lg:flex-row lg:items-start lg:justify-between"
                >
                  <div>
                    <h4
                      class="text-lg font-semibold text-gray-800 dark:text-white/90 lg:mb-6"
                    >
                      Personal Information
                    </h4>

                    <div
                      class="grid grid-cols-1 gap-4 lg:grid-cols-2 lg:gap-7 2xl:gap-x-32"
                    >
                      <div>
                        <p
                          class="mb-2 text-xs leading-normal text-gray-500 dark:text-gray-400"
                        >
                          First Name
                        </p>
                        <p
                          class="text-sm font-medium text-gray-800 dark:text-white/90"
                          x-text="firstName || '-'"
                        ></p>
                      </div>

                      <div>
                        <p
                          class="mb-2 text-xs leading-normal text-gray-500 dark:text-gray-400"
                        >
                          Last Name
                        </p>
                        <p
                        class="text-sm font-medium text-gray-800 dark:text-white/90"
                        x-text="lastName || '-'"
                      ></p>
                      </div>

                      <div>
                        <p
                          class="mb-2 text-xs leading-normal text-gray-500 dark:text-gray-400"
                        >
                          Email address
                        </p>
                        <p
                          class="text-sm font-medium text-gray-800 dark:text-white/90 break-all"
                          x-text="email || '-'"
                        ></p>
                      </div>

                      <div>
                        <p
                          class="mb-2 text-xs leading-normal text-gray-500 dark:text-gray-400"
                        >
                          Role
                        </p>
                        <p
                          class="text-sm font-medium text-gray-800 dark:text-white/90"
                          x-text="role || 'USER'"
                        ></p>
                      </div>

                      <div class="lg:col-span-2">
                        <p
                          class="mb-2 text-xs leading-normal text-gray-500 dark:text-gray-400"
                        >
                          Biography
                        </p>
                        <p
                          class="text-sm font-medium text-gray-800 whitespace-pre-line dark:text-white/90"
                          x-text="bio || `You haven't added a biography yet.`"
                        ></p>
                      </div>
                    </div>

                    <!-- Mensaje de error (opcional) -->
                    <template x-if="profileError">
                      <div
                        class="mt-4 text-sm text-red-600 bg-red-50 border border-red-200 rounded-lg px-4 py-3 dark:bg-red-900/20 dark:border-red-800"
                        x-text="profileError"
                      ></div>
                    </template>
                  </div>

                  <button
                    @click="isProfileInfoModal = true"
                    class="flex w-full items-center justify-center gap-2 rounded-full border border-gray-300 bg-white px-4 py-3 text-sm font-medium text-gray-700 shadow-theme-xs hover:bg-gray-50 hover:text-gray-800 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg:white/[0.03] dark:hover:text-gray-200 lg:inline-flex lg:w-auto"
                  >
                    <svg
                      class="fill-current"
                      width="18"
                      height="18"
                      viewBox="0 0 18 18"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        fill-rule="evenodd"
                        clip-rule="evenodd"
                        d="M15.0911 2.78206C14.2125 1.90338 12.7878 1.90338 11.9092 2.78206L4.57524 10.116C4.26682 10.4244 4.0547 10.8158 3.96468 11.2426L3.31231 14.3352C3.25997 14.5833 3.33653 14.841 3.51583 15.0203C3.69512 15.1996 3.95286 15.2761 4.20096 15.2238L7.29355 14.5714C7.72031 14.4814 8.11172 14.2693 8.42013 13.9609L15.7541 6.62695C16.6327 5.74827 16.6327 4.32365 15.7541 3.44497L15.0911 2.78206ZM12.9698 3.84272C13.2627 3.54982 13.7376 3.54982 14.0305 3.84272L14.6934 4.50563C14.9863 4.79852 14.9863 5.2734 14.6934 5.56629L14.044 6.21573L12.3204 4.49215L12.9698 3.84272ZM11.2597 5.55281L5.6359 11.1766C5.53309 11.2794 5.46238 11.4099 5.43238 11.5522L5.01758 13.5185L6.98394 13.1037C7.1262 13.0737 7.25666 13.003 7.35947 12.9002L12.9833 7.27639L11.2597 5.55281Z"
                        fill=""
                      />
                    </svg>
                    Edit
                  </button>
                </div>
              </div>
            </div>
          </div>
        </main>
        <!-- ===== Main Content End ===== -->
      </div>
      <!-- ===== Content Area End ===== -->
    </div>
    <!-- ===== Page Wrapper End ===== -->

    <!-- MODALES -->
    <include src="./partials/profile/profile-info-modal.html" />
  </body>

  <!-- SCRIPT PARA LA LÓGICA DEL PERFIL -->
  <script>
    function profilePage() {
      return {
        page: 'profile',
        loaded: true,
        darkMode: false,
        stickyMenu: false,
        sidebarToggle: false,
        scrollTop: false,
        isProfileInfoModal: false,

        // datos de usuario
        firstName: '',
        lastName: '',
        email: '',
        bio: '',
        role: 'USER',

        // mensajes
        profileError: '',
        profileSuccess: false,

        init() {
          this.darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
          this.$watch('darkMode', value =>
            localStorage.setItem('darkMode', JSON.stringify(value))
          );

          this.loadUserProfile();
        },

        async loadUserProfile() {
          const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');

          if (userInfo.fullName) {
            const names = userInfo.fullName.split(' ');
            this.firstName = names[0] || '';
            this.lastName = names.slice(1).join(' ') || '';
          }

          this.email = userInfo.email || this.email || '';
          this.bio = userInfo.bio || this.bio || '';
          this.role = userInfo.role || this.role || 'USER';

          try {
            const token = localStorage.getItem('jwtToken');
            if (!token) return;

            const response = await fetch(
              `${LOCAL_API}/users/profile`,
              {
                method: 'GET',
                headers: {
                  Authorization: 'Bearer ' + token,
                },
              }
            );

            if (response.ok) {
              const data = await response.json();

              this.firstName = data.firstName || this.firstName;
              this.lastName = data.lastName || this.lastName;
              this.email = data.email || this.email;
              this.bio = data.bio || this.bio || '';
              this.role = data.role || this.role || 'USER';

              const updatedUserInfo = {
                fullName: (this.firstName + ' ' + this.lastName).trim(),
                email: this.email,
                bio: this.bio,
                role: this.role,
              };
              localStorage.setItem('userInfo', JSON.stringify(updatedUserInfo));
            }
          } catch (error) {
            console.error('Error loading profile on Profile page:', error);
          }
        },

        async updateProfile() {
          this.profileError = '';
          this.profileSuccess = false;

          this.firstName = (this.firstName || '').trim();
          this.lastName  = (this.lastName  || '').trim();
          this.email     = (this.email     || '').trim();
          this.bio       = (this.bio       || '').trim();

          if (!this.firstName || !this.lastName) {
            this.profileError = 'El nombre y apellido son requeridos.';
            return;
          }

          if (!this.email) {
            this.profileError = 'El email es requerido.';
            return;
          }

          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(this.email)) {
            this.profileError = 'Por favor ingresa un email válido.';
            return;
          }

          const token = localStorage.getItem('jwtToken');
          if (!token) {
            this.profileError =
              'No estás autenticado. Por favor, inicia sesión nuevamente.';
            this.showNotification(
              'Sesión expirada. Redirigiendo al login...',
              'error'
            );
            setTimeout(() => {
              window.location.href = '/signin.html';
            }, 2000);
            return;
          }

          try {
            const response = await fetch(
              `${LOCAL_API}/users/profile`,
              {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json',
                  Authorization: 'Bearer ' + token,
                },
                body: JSON.stringify({
                  firstName: this.firstName,
                  lastName: this.lastName,
                  email: this.email,
                  bio: this.bio,
                }),
              }
            );

            if (!response.ok) {
              if (response.status === 401) {
                this.profileError =
                  'Tu sesión ha expirado. Por favor, inicia sesión nuevamente.';
                this.showNotification(
                  'Sesión expirada. Redirigiendo al login...',
                  'error'
                );
                localStorage.removeItem('jwtToken');
                localStorage.removeItem('userInfo');
                setTimeout(() => {
                  window.location.href = '/signin.html';
                }, 2000);
                return;
              }

              const errorText = await response.text();
              let errorMessage = 'Error al actualizar el perfil.';
              try {
                const data = JSON.parse(errorText);
                errorMessage = data.error || data.message || errorMessage;
              } catch (_) {
                if (errorText) errorMessage = errorText;
              }
              this.profileError = errorMessage;
              this.showNotification('Error al actualizar el perfil', 'error');
              return;
            }

            const data = await response.json();
            this.firstName = data.firstName || this.firstName;
            this.lastName  = data.lastName  || this.lastName;
            this.email     = data.email     || this.email;
            this.bio       = data.bio       || this.bio;
            this.role      = data.role      || this.role;

            const userInfo = {
              fullName: (this.firstName + ' ' + this.lastName).trim(),
              email: this.email,
              bio: this.bio,
              role: this.role,
            };
            localStorage.setItem('userInfo', JSON.stringify(userInfo));

            this.profileSuccess = true;
            this.showNotification('Profile updated successfully!', 'success');

            this.isProfileInfoModal = false;
            setTimeout(() => {
              this.profileSuccess = false;
            }, 4000);
          } catch (error) {
            console.error('Error actualizando perfil:', error);
            if (
              error.message &&
              (error.message.includes('Failed to fetch') ||
                error.message.includes('NetworkError'))
            ) {
              this.profileError =
                'No se puede conectar con el servidor. Verifica tu conexión a internet.';
            } else {
              this.profileError =
                'Error de conexión. Verifica tu conexión a internet.';
            }
            this.showNotification('Error de conexión', 'error');
          }
        },

        showNotification(message, type = 'info') {
          const notification = document.createElement('div');
          notification.className =
            'fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ' +
            (type === 'success'
              ? 'bg-green-500 text-white'
              : type === 'error'
              ? 'bg-red-500 text-white'
              : 'bg-blue-500 text-white');
          notification.textContent = message;
          document.body.appendChild(notification);
          setTimeout(() => notification.remove(), 3000);
        },

        getRoleLabel() {
          const roles = {
            USER: 'Usuario',
            ADVISOR: 'Asesor Financiero',
            ADMIN: 'Administrador',
          };
          return roles[this.role] || 'Usuario';
        },
      };
    }
  </script>
</html>
