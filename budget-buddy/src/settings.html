<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Settings | BudgetBuddy</title>
    <script>
      window.currentPage = 'settings';
      const LOCAL_API = 'http://localhost:8081';
    </script>
  </head>
  <body
    data-page="settings"
    x-data="{
      page: 'settings',
      loaded: true, 
      darkMode: false, 
      stickyMenu: false, 
      sidebarToggle: false, 
      scrollTop: false,

      currentPassword: '',
      newPassword: '',
      confirmPassword: '',
      passwordError: '',
      passwordSuccess: false,

      showCurrent: false,
      showNew: false,
      showConfirm: false,

      async init() {
        // dark mode
        this.darkMode = JSON.parse(localStorage.getItem('darkMode')) || false;
        this.$watch('darkMode', value => 
          localStorage.setItem('darkMode', JSON.stringify(value))
        );

        // validar token antes de seguir
        const token = localStorage.getItem('jwtToken');
        if (!token) {
          window.location.href = './signin.html';
          return;
        }
      },

      async changePassword() {
        this.passwordError = '';
        this.passwordSuccess = false;
        
        if (this.newPassword !== this.confirmPassword) {
          this.passwordError = 'Las contraseñas no coinciden.';
          return;
        }
        
        if (this.newPassword.length < 6) {
          this.passwordError = 'La nueva contraseña debe tener al menos 6 caracteres.';
          return;
        }
        
        try {
          const token = localStorage.getItem('jwtToken');
          if (!token) {
            this.passwordError = 'No estás autenticado. Por favor, inicia sesión nuevamente.';
            this.showNotification('Sesión expiada. Redirigiendo al login...', 'error');
            setTimeout(() => {
              window.location.href = '/signin.html';
            }, 2000);
            return;
          }
          
          const response = await fetch(`${LOCAL_API}/users/change-password`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              currentPassword: this.currentPassword,
              newPassword: this.newPassword
            })
          });
          
          if (response.ok) {
            this.passwordSuccess = true;
            this.currentPassword = '';
            this.newPassword = '';
            this.confirmPassword = '';
            this.showNotification('Contraseña cambiada exitosamente', 'success');
            
            setTimeout(() => {
              this.passwordSuccess = false;
            }, 5000);
          } else if (response.status === 401) {
            this.passwordError = 'Tu sesión ha expiado. Por favor, inicia sesión nuevamente.';
            this.showNotification('Sesión expiada. Redirigiendo al login...', 'error');
            localStorage.removeItem('jwtToken');
            localStorage.removeItem('userInfo');
            setTimeout(() => {
              window.location.href = '/signin.html';
            }, 2000);
          } else if (response.status === 404) {
            this.passwordError = 'La funcionalidad de cambio de contraseña no está disponible en este momento.';
            this.showNotification('Funcionalidad no disponible', 'error');
          } else {
            const errorText = await response.text();
            let errorMessage = 'Error al cambiar la contraseña.';
            
            try {
              const data = JSON.parse(errorText);
              errorMessage = data.error || data.message || errorMessage;
            } catch (e) {
              if (errorText) {
                errorMessage = errorText;
              }
            }
            
            this.passwordError = errorMessage;
            this.showNotification('Error al cambiar la contraseña', 'error');
          }
        } catch (error) {
          console.error('Error cambiando contraseña:', error);
          if (error.message && (error.message.includes('Failed to fetch') || error.message.includes('NetworkError'))) {
            this.passwordError = 'No se puede conectar con el servidor. Verifica tu conexión a internet.';
            this.showNotification('Error de conexión', 'error');
          } else {
            this.passwordError = 'Error de conexión. Verifica tu conexión a internet.';
            this.showNotification('Error de conexión', 'error');
          }
        }
      },

      logout() {
        localStorage.removeItem('jwtToken');
        window.location.href = './signin.html';
      },
      
      showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
          type === 'success' ? 'bg-green-500 text-white' :
          type === 'error' ? 'bg-red-500 text-white' :
          'bg-blue-500 text-white'
        }`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.remove();
        }, 3000);
      },
      
      clearMessages() {
        this.passwordError = '';
        this.passwordSuccess = false;
      },

      togglePassword(field) {
        let ref = null;
        let state = null;

        if (field === 'current') {
          ref = this.$refs.currentPass;
          this.showCurrent = !this.showCurrent;
          state = this.showCurrent;
        }
        if (field === 'new') {
          ref = this.$refs.newPass;
          this.showNew = !this.showNew;
          state = this.showNew;
        }
        if (field === 'confirm') {
          ref = this.$refs.confirmPass;
          this.showConfirm = !this.showConfirm;
          state = this.showConfirm;
        }

        if (ref) {
          ref.type = state ? 'text' : 'password';
        }
      }
    }"
    x-init="init()"
    :class="{'dark bg-gray-900': darkMode === true}"
  >
    <!-- ===== Preloader Start ===== -->
    <include src="./partials/preloader.html"></include>
    <!-- ===== Preloader End ===== -->

    <!-- ===== Page Wrapper Start ===== -->
    <div class="flex h-screen overflow-hidden">
      <!-- ===== Sidebar Start ===== -->
      <include src="./partials/sidebar.html"></include>
      <!-- ===== Sidebar End ===== -->

      <!-- ===== Content Area Start ===== -->
      <div
        class="relative flex flex-col flex-1 overflow-x-hidden overflow-y-auto"
      >
        <!-- Small Device Overlay Start -->
        <include src="./partials/overlay.html" />
        <!-- Small Device Overlay End -->

        <!-- ===== Header Start ===== -->
        <include src="./partials/header.html" />
        <!-- ===== Header End ===== -->

        <!-- ===== Main Content Start ===== -->
        <main>
          <div class="p-4 mx-auto max-w-(--breakpoint-2xl) md:p-6">
            
            <!-- Breadcrumb Start -->
            <div x-data="{ pageName: `Settings` }">
              <include src="./partials/breadcrumb.html" />
            </div>
            <!-- Breadcrumb End -->

            <!-- ===== Contenedor principal ===== -->
            <div class="rounded-2xl border border-gray-200 bg-white p-5 dark:border-gray-800 dark:bg-white/[0.03] lg:p-6">
              
              <h3 class="mb-5 text-lg font-semibold text-gray-800 dark:text-white/90 lg:mb-7">
                Account Settings
              </h3>

              <!-- === Card: Change Password  === -->
              <div class="p-5 mb-6 border border-gray-200 rounded-2xl dark:border-gray-800 lg:p-6">
                <h4 class="mb-6 text-lg font-semibold text-gray-800 dark:text-white/90">
                  Change Password
                </h4>

                <div class="grid grid-cols-1 gap-5">

                <div class="flex flex-col">
                  <label class="mb-1 text-xs text-gray-500 dark:text-gray-400">Current Password</label>

                  <div class="relative">
                    <input
                      x-ref="currentPass"
                      type="password"
                      x-model="currentPassword"
                      placeholder="Enter your current password"
                      @input="clearMessages()"
                      class="h-11 w-full rounded-lg border border-gray-300 appearance-none px-4 py-2.5 text-sm shadow-theme-xs 
                      placeholder:text-gray-400 focus:outline-none focus:border-brand-300 focus:ring focus:ring-brand-300
                      dark:focus:outline-none dark:focus:border-brand-500 dark:focus:ring dark:focus:ring-brand-500
                      dark:bg-gray-900 dark:border-gray-700 dark:text-white/90 dark:placeholder:text-white/30"
                    />

                    <button
                      type="button"
                      class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400"
                      @click="
                        showCurrent = !showCurrent;
                        $refs.currentPass.type = showCurrent ? 'text' : 'password';
                      "
                    >
                      <!-- ojo abierto -->
                      <svg x-show="showCurrent" class="w-5 h-5" fill="none" stroke="currentColor"
                          viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943
                          9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                      </svg>

                      <!-- ojo cerrado -->
                      <svg x-show="!showCurrent" class="w-5 h-5" fill="none" stroke="currentColor"
                          viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7a9.973 9.973 0 012.541-4.362"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M6.18 6.18A9.99 9.99 0 0112 5c4.478 0 8.268 2.943
                          9.542 7a9.956 9.956 0 01-4.043 5.197"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M3 3l18 18"/>
                      </svg>
                    </button>

                  </div>
                </div>

                <div class="flex flex-col">
                  <label class="mb-1 text-xs text-gray-500 dark:text-gray-400">New Password</label>

                  <div class="relative">
                    <input
                      x-ref="newPass"
                      type="password"
                      x-model="newPassword"
                      placeholder="Minimum 6 characters"
                      @input="clearMessages()"
                      class="h-11 w-full rounded-lg border border-gray-300 appearance-none px-4 py-2.5 text-sm shadow-theme-xs 
                      placeholder:text-gray-400 focus:outline-none focus:border-brand-300 focus:ring focus:ring-brand-300
                      dark:focus:outline-none dark:focus:border-brand-500 dark:focus:ring dark:focus:ring-brand-500
                      dark:bg-gray-900 dark:border-gray-700 dark:text-white/90 dark:placeholder:text-white/30"
                    />

                  <button
                    type="button"
                    class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400"
                    @click="
                      showNew = !showNew;
                      $refs.newPass.type = showNew ? 'text' : 'password';
                    "
                  >
                    <svg x-show="showNew" class="w-5 h-5" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943
                        9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>

                    <svg x-show="!showNew" class="w-5 h-5" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7a9.973 9.973 0 012.541-4.362"/>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M6.18 6.18A9.99 9.99 0 0112 5c4.478 0 8.268 2.943
                        9.542 7a9.956 9.956 0 01-4.043 5.197"/>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 3l18 18"/>
                    </svg>
                  </button>

                  </div>
                </div>

                <div class="flex flex-col">
                  <label class="mb-1 text-xs text-gray-500 dark:text-gray-400">Confirm New Password</label>

                  <div class="relative">
                    <input
                      x-ref="confirmPass"
                      type="password"
                      x-model="confirmPassword"
                      placeholder="Repeat the new password"
                      @input="clearMessages()"
                      class="h-11 w-full rounded-lg border border-gray-300 appearance-none px-4 py-2.5 text-sm shadow-theme-xs 
                      placeholder:text-gray-400 focus:outline-none focus:border-brand-300 focus:ring focus:ring-brand-300
                      dark:focus:outline-none dark:focus:border-brand-500 dark:focus:ring dark:focus:ring-brand-500
                      dark:bg-gray-900 dark:border-gray-700 dark:text-white/90 dark:placeholder:text-white/30"
                    />

                  <button
                    type="button"
                    class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400"
                    @click="
                      showConfirm = !showConfirm;
                      $refs.confirmPass.type = showConfirm ? 'text' : 'password';
                    "
                  >
                    <svg x-show="showConfirm" class="w-5 h-5" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943
                        9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>

                    <svg x-show="!showConfirm" class="w-5 h-5" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7a9.973 9.973 0 012.541-4.362"/>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M6.18 6.18A9.99 9.99 0 0112 5c4.478 0 8.268 2.943
                        9.542 7a9.956 9.956 0 01-4.043 5.197"/>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 3l18 18"/>
                    </svg>
                  </button>

                  </div>
                </div>

                </div>

                <!-- Mensajes -->
              <template x-if="passwordError">
                <p class="mt-4 text-sm text-red-600 bg-red-50 border border-red-200 px-4 py-3 rounded-lg dark:bg-red-900/20 dark:border-red-800"
                  x-text="passwordError"></p>
              </template>

              <template x-if="passwordSuccess">
                <div
                  class="mt-4 flex items-center gap-3 text-green-700 bg-green-50 border border-green-200 px-4 py-3 rounded-xl shadow-sm dark:bg-green-900/20 dark:border-green-800">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600" viewBox="0 0 20 20"
                    fill="currentColor">
                    <path fill-rule="evenodd"
                      d="M16.707 5.293a1 1 0 010 1.414l-7.25 7.25a1 1 0 01-1.414 0L3.293 9.207a1 1 0 011.414-1.414l4.043 4.043 6.543-6.543a1 1 0 011.414 0z"
                      clip-rule="evenodd" />
                  </svg>
                  <span>Password updated successfully!</span>
                </div>
              </template>

                <div class="mt-6 flex justify-end">
                  <button
                    @click="changePassword()"
                    class="inline-flex items-center justify-center rounded-full bg-brand-500 px-6 py-3 text-sm font-medium text-white shadow-theme-xs hover:bg-brand-600 dark:bg-brand-500 dark:hover:bg-brand-600">
                    Update Password
                  </button>
                </div>
              </div>

              <!-- === Card: Theme === -->
              <div class="p-5 mb-6 border border-gray-200 rounded-2xl dark:border-gray-800 lg:p-6">
                <h4 class="mb-4 text-lg font-semibold text-gray-800 dark:text-white/90">
                  Theme
                </h4>
                <p class="text-sm text-gray-600 dark:text-gray-400">Switch between light and dark theme</p>

                <div class="mt-6 flex justify-end">
                  <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" x-model="darkMode" class="sr-only peer" />
                    <div
                      class="relative w-16 h-8 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 
                      peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 rounded-full peer 
                      dark:bg-gray-700 
                      peer-checked:after:translate-x-full peer-checked:after:border-white 
                      after:content-[''] after:absolute after:top-[3px] after:left-[3px] 
                      after:bg-white after:border-gray-300 after:border after:rounded-full 
                      after:h-7 after:w-7 after:transition-all dark:border-gray-600 
                      peer-checked:bg-blue-600">
                    </div>
                  </label>
                </div>

              </div>

              <!-- === Card: Logout === -->
              <div class="p-5 border border-gray-200 rounded-2xl dark:border-gray-800 lg:p-6">
                <h4 class="mb-4 text-lg font-semibold text-gray-800 dark:text-white/90">
                  Session
                </h4>
                <p class="text-sm text-gray-600 dark:text-gray-400">Close your current session</p>

              <div class="mt-6 flex justify-end">
                <button
                  @click="logout()"
                  class="inline-flex items-center justify-center rounded-full border border-gray-300 bg-white px-6 py-3 text-sm font-medium text-gray-700 shadow-theme-xs hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-white/[0.03]">
                  Log Out
                </button>
              </div>

            </div>
          </div>
        </main>

        <!-- ===== Main Content End ===== -->
      </div>
      <!-- ===== Content Area End ===== -->
    </div>
    <!-- ===== Page Wrapper End ===== -->
  </body>
  
  <script>
  // check token contra backend local
  function checkAuth() {
    const token = localStorage.getItem("jwtToken");
    if (!token) {
      if (isProtectedPage()) {
        window.location.href = "./signin.html";
      }
      return;
    }

    fetch(`${LOCAL_API}/auth/verify`, {
      headers: {
        Authorization: `Bearer ${token}`,
      },
    })
      .then((res) => {
        if (!res.ok) throw new Error("Token inválido");
        return res.json();
      })
      .then((data) => {
        if (data.valid) {
          const user = data.user;

          if (user.role === "ADVISOR" && isProtectedPage() && getCurrentPage() !== "settings.html") {
            window.location.href = "./index.html";
            return;
          }

          if (!localStorage.getItem("userInfo")) {
            const userInfo = {
              fullName: user.firstName + " " + user.lastName,
              email: user.email,
            };
            localStorage.setItem("userInfo", JSON.stringify(userInfo));
          }

          updateUserInfo();
        } else {
          throw new Error("Token inválido");
        }
      })
      .catch((err) => {
        console.error("Auth error:", err.message);
        localStorage.removeItem("jwtToken");
        localStorage.removeItem("userInfo");
        window.location.href = "./signin.html";
      });
  }
  </script>
</html>
